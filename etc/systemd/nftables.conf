#!/usr/bin/nft -f
# vim:set ts=2 sw=2 et:

# 0. 清空旧规则，确保环境纯净
destroy table inet filter

table inet filter {
  # [变量定义]
  # 定义私有局域网段 (RFC 1918)
  # 作用：只有这些网段才有资格尝试连接代理，公网 IP 直接丢弃
  set private_networks {
    type ipv4_addr
    flags interval
    elements = { 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 }
  }

  # 定义 Mihomo 开放的 TCP 端口 (代理+控制)
  set mihomo_tcp {
    type inet_service
    elements = { 7890, 7891, 7892, 7893, 7894, 9090 }
  }

  # 定义 Mihomo 开放的 UDP 端口 (DNS+代理)
  set mihomo_udp {
    type inet_service
    elements = { 7890, 7891, 7892, 53, 5450 }
  }

  chain input {
    # [默认策略] 拒绝所有，除非明确允许 (白名单模式)
    type filter hook input priority filter; policy drop;

    # 1. [核心基础] 
    # 允许本地环回 (Localhost) 通信，系统稳定基石
    iif lo accept
    # 允许已建立的连接和相关联的流量 (Stateful Firewall 核心)
    ct state {established, related} accept
    # 丢弃无效的数据包 (防止畸形包攻击)
    ct state invalid drop

    # 2. [网络基础设施]
    # 允许 DHCP 客户端获取 IP (UDP 68)，防止连上 Wi-Fi 却无法获得 IP
    udp dport 68 accept

    # 3. [Mihomo 专属通道]
    # 允许来自 Meta 虚拟网卡的流量 (TUN 模式必须)
    iifname "Meta" accept
    # 允许 Fake-IP 范围的流量 (防止 DNS 劫持导致的丢包)
    ip daddr 198.19.0.0/16 accept

    # 4. [ICMP 控制]
    # 仅允许 Ping 请求，且限制速率 (5个/秒)，防止 ICMP Flood 和扫描
    ip protocol icmp icmp type echo-request limit rate 5/second accept
    ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 5/second accept

    # 5. [SSH 安全 - 零信任]
    # 无论来自内网还是外网，SSH 均强制限速 (每分钟4次，突发2次)
    # 配合系统内的 "PasswordAuthentication no"，可防御一切爆破
    tcp dport ssh ct state new limit rate over 4/minute burst 2 packets drop
    tcp dport ssh accept

    # 6. [代理服务 - 纵深防御]
    # 第一层过滤：仅允许 RFC1918 私有网段 IP 连接 (挡住公网扫描)
    # 第二层防御：Mihomo 的 config.yaml 密码认证 (挡住内网未授权用户)
    ip saddr @private_networks tcp dport @mihomo_tcp ct state new accept
    ip saddr @private_networks udp dport @mihomo_udp ct state new accept

    # 7. [隐身模式]
    # 默认 Policy Drop 会处理剩余流量，不回复 Reject，让机器在网络上隐身
  }

  chain forward {
    # [转发控制] 默认丢弃，防止笔记本变成路由器转发垃圾流量
    type filter hook forward priority filter; policy drop;
    
    # 仅允许 Mihomo 的 TUN 接口进行流量转发
    iifname "Meta" accept
    oifname "Meta" accept
  }

  chain output {
    # [出站控制] 默认允许所有出站
    type filter hook output priority filter; policy accept;
  }
}
